<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../../img/favicon.ico" />
    <title>Using WebDataset as a Column Store - webdataset</title>
    <link rel="stylesheet" href="../../../css/theme.css" />
    <link rel="stylesheet" href="../../../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../../../assets/_mkdocstrings.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Using WebDataset as a Column Store";
        var mkdocs_page_input_path = "examples/webdataset/column-store.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../.." class="icon icon-home"> webdataset
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../..">README</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../webdataset/">WebDataset</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../wids/">WIDS</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../../FAQ/">FAQ</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Examples</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" >webdataset</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../">Index</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../wds-notes/">Wds notes</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../generate-text-dataset/">Dataset Generation</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../tesseract-wds/">Tesseract wds</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../train-resnet50-wds/">Resnet 50 Training on (Fake)Imagenet with WebDataset</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../train-resnet50-multiray-wds/">WebDataset + Distributed PyTorch Training</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../train-ocr-errors-hf/">Fine Tuning LLM with Huggingface and WebDataset</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../mi-images/">Mini Imagenet Generation</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../mi-prompts/">Mini Imagenet Generation</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="#">Using WebDataset as a Column Store</a>
    <ul class="current">
    </ul>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >wids</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../wids/">Index</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../wids/train-resnet50-wids/">Train resnet50 wids</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../wids/train-resnet50-multiray-wids/">WebIndexedDataset + Distributed PyTorch Training</a>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../..">webdataset</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../.." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Examples</li>
          <li class="breadcrumb-item">webdataset</li>
      <li class="breadcrumb-item active">Using WebDataset as a Column Store</li>
    <li class="wy-breadcrumbs-aside">
          <a href="http://github.com/webdataset/webdataset/edit/master/docs/examples/webdataset/column-store.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="using-webdataset-as-a-column-store">Using WebDataset as a Column Store</h1>
<p>Sometimes it is desirable to break up a dataset not just by rows but also by columns.
This is quite easy in WebDataset, although there is no explicit API for it (one will likely be added).</p>
<p>The idea is to just use the <code>__url__</code> field in a sample to load additional columns as necessary.</p>
<pre><code class="language-python"># We usually abbreviate webdataset as wds
import webdataset as wds
</code></pre>
<pre><code class="language-python">batchsize = 32
bucket = &quot;https://storage.googleapis.com/webdataset/fake-imagenet&quot;
training_urls = bucket + &quot;/imagenet-train-{000000..001281}.tar&quot;
</code></pre>
<pre><code class="language-python"># Create the datasets with shard and sample shuffling and decoding.
trainset = wds.WebDataset(training_urls, resampled=True, shardshuffle=True)

</code></pre>
<p>This function computes the URL for an additional column from a base URL. This is
then used by the <code>add_column</code> function to add data from that additional URL to the
data already loaded from the base URL.</p>
<pre><code class="language-python">def find_column_url(url):
    # In this function, given the main URL for a shard, find the corresponding
    # extra column URL.

    # For the demo, we just return the same URL, which means that we simply
    # add the same values to the samples twice.
    return url # .replace(&quot;-train&quot;, &quot;-train-more&quot;)
</code></pre>
<pre><code class="language-python">def add_column(src, find_column_url=find_column_url):
    &quot;&quot;&quot;Given an iterator over a dataset, add an extra column from a separate dataset.&quot;&quot;&quot;
    last_url = None
    column_src = None
    for sample in src:
        # We use the __url__ field to keep track of which shard we are working on.
        # We then open the corresponding URL for the extra column data if necessary.
        if last_url != sample[&quot;__url__&quot;]:
            column_url = find_column_url(sample[&quot;__url__&quot;])
            print(&quot;*** opening column_url&quot;, column_url)
            column_src = iter(wds.WebDataset(column_url, shardshuffle=False))
            last_url = sample[&quot;__url__&quot;]
        # Read the next sample from the extra column data.
        extra = next(column_src)
        # Check that the keys match.
        assert extra[&quot;__key__&quot;] == sample[&quot;__key__&quot;]
        # Update the sample with the extra data.
        for k, v in extra.items():
            if k[0] != &quot;_&quot;:
                sample[k] = v
        yield sample

trainset = trainset.compose(add_column)

# NB: any shuffling, decoding, etc. needs to happen after the `add_column` call
</code></pre>
<p>Let's see all of it in action. Actually, nothing particularly interesting happens here
because we are just loading the same data for the base URL and the additional column.
Really, the only feedback you get from this code is the message about opening the column_url.</p>
<pre><code class="language-python">for k, v in next(iter(trainset)).items():
    print(k, repr(v)[:60])
</code></pre>
<p>Some comments:</p>
<ul>
<li>The code above assumes an exact correspondence between the samples in the different columnn shards; this is really what you ought to aim for. But you can add code to skip data.</li>
<li>For small amounts of data (like class labels), you probably just want to store the data in a dbm-style database and use <code>.associate(data)</code>.</li>
<li>You could also use <code>wids</code> to retrieve additional samples in <code>add_column</code>.</li>
</ul>
<p>If you want to do the same thing in <code>wids</code>, the code becomes even simpler:</p>
<pre><code class="language-Python">class CombinedDataset:
    def __init__(self, ds1, ds2):
        self.ds1 = wids.ShardListDataset(ds1)
        self.ds2 = wids.ShardListDataset(ds2)
        assert len(self.ds1) == len(self.ds2)
    def getitem(self, index):
        return self.ds1[index].update(self.ds2[index])
    def __len__(self):
        return len(self.ds1)
</code></pre>
<pre><code class="language-python">
</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../mi-prompts/" class="btn btn-neutral float-left" title="Mini Imagenet Generation"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../../wids/" class="btn btn-neutral float-right" title="Index">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="http://github.com/webdataset/webdataset" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../mi-prompts/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../../wids/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../../../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "../../..";</script>
    <script src="../../../js/theme_extra.js"></script>
    <script src="../../../js/theme.js"></script>
      <script src="../../../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
